# 拼伞小程序后端技术方案

## 用户登录

登录时存储用户的微信昵称，性别，微信号(作为主键)

## 实时地图页面(‘/’)

读取数据库的Neednotes和OfferNoes中所有过期时间timestamp大于当前时间的Notes，发送给前端。在地图上，对每一条Notes记录的位置渲染小伞图片，点击时弹窗显示发送该Notes的用户昵称、头像、备注信息和发送的时间，分别对需要伞和提供伞的触发`给ta提供伞`或`请求ta为我提供伞`两个路由。

- 路由一：给ta提供伞，输入备注，确认后，发送通知给需要伞的用户，通知ta有人愿意为ta提供伞，是否接受，接受或拒绝后再回复一个通知给提供伞的用户。
  - 传输的数据：提供伞的用户的id、昵称、头像以及备注。
- 路由二：请求ta为我提供伞，基本同上。
  - 传输的数据：同上。

- 路由三：升级我的小伞(我提供伞)，点起后发起一个request请求到`www.****.com/iofferumbrella`
  - 传输的数据：用户的id，用户的昵称，用户的头像。
- 路由四：我需要伞，点击后发起一个request请求到`www.****.com/ineedumbrella`。
  - 传输的数据：同上。

难点：

1. 如何每当一个新的Notes产生时刷新页面，让所有用户都看到。初步想法，提供一个刷新按钮，点击刷新当前页面。
2. 有待发现...

## 我需要伞页面(‘/ineedumbrella’)

### 需要的数据：

- 位置：获得用户当前的位置坐标，并在地图上该位置渲染小伞图片
- 备注：要去哪里，什么时候去？
- 有效期：5/10分钟，超时后将该Notes的is_active设为False

确认提交后，根据所给信息新建一个NeedNotes，提交到数据库。

## 升级小伞(‘iofferumbrella’)

### 表单：

- 位置：同上

- 备注：何时何地能帮助同学？

- 有效期：同上

确认提交后，根据所给信息新建一个OfferNotes，提交到数据库。

## 成功拼伞(‘/successhelp’)

显示提供伞的用户等级+1，即success_counts加一，获得新的小伞图案和头像边框。根据等级在主页放置小伞时渲染不同的图片。

重定向回主页。

难点：

1. 如何确认拼伞成功，将用户送到了指定的位置。
2. 有待发现...

## 数据库

### 用户模型(Users)

属性

- id(主键)
- 微信号wx
- 昵称username(默认为微信昵称, 暂不提供个人资料修改)
- 性别sex(默认为男，0代表女，1代表男)
- 成功帮助他人的次数success_counts(默认为0)
- neednotes(发起过请求伞的通知)
- offernotes(发起过提供伞的通知)

### 需要伞请求(NeedNotes)

- id(主键)

- 发起通知的用户user_id(外键)

- 通知的内容，即用户在发起请求时输入的备注content

- 过期时间timestamp(默认为当前时间加上有效期时间)

### 提供伞请求(OfferNotes)

基本同上